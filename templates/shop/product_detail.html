{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - O'simlik Do'koni{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-10">
    <nav class="text-sm text-eco-dark-gray mb-6" aria-label="breadcrumb">
        <ol class="flex items-center gap-2">
            <li><a href="{% url 'shop:home' %}" class="hover:text-eco-green">Bosh sahifa</a></li>
            <li>/</li>
            <li><a href="{% url 'shop:product_list' %}" class="hover:text-eco-green">Mahsulotlar</a></li>
            <li>/</li>
            <li class="text-gray-800 font-semibold">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="grid gap-8 lg:grid-cols-2">
        <!-- Gallery -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
            <div class="relative rounded-xl overflow-hidden bg-eco-gray h-80 flex items-center justify-center">
                {% with main=product.main_image|default_if_none:product.image_2|default_if_none:product.image_3|default_if_none:product.image_4 %}
                {% if main %}
                <img src="{{ main.url }}" alt="{{ product.name }}" class="h-full w-full object-cover">
                {% else %}
                <div class="text-eco-dark-gray text-3xl"><i class="fas fa-seedling"></i></div>
                {% endif %}
                {% endwith %}
                {% if product.has_discount %}
                <span class="absolute top-4 right-4 bg-rose-500 text-white text-xs px-3 py-1 rounded-full">-{{ product.discount_percentage|floatformat:0 }}%</span>
                {% endif %}
                {% if not product.is_in_stock %}
                <span class="absolute top-4 left-4 bg-gray-900 text-white text-xs px-3 py-1 rounded-full">Mavjud emas</span>
                {% endif %}
            </div>
            <div class="mt-3 grid grid-cols-4 gap-3">
                {% if product.main_image %}
                <div class="h-16 rounded-lg overflow-hidden bg-eco-gray">
                    <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="h-full w-full object-cover">
                </div>
                {% endif %}
                {% if product.image_2 %}
                <div class="h-16 rounded-lg overflow-hidden bg-eco-gray">
                    <img src="{{ product.image_2.url }}" alt="{{ product.name }}" class="h-full w-full object-cover">
                </div>
                {% endif %}
                {% if product.image_3 %}
                <div class="h-16 rounded-lg overflow-hidden bg-eco-gray">
                    <img src="{{ product.image_3.url }}" alt="{{ product.name }}" class="h-full w-full object-cover">
                </div>
                {% endif %}
                {% if product.image_4 %}
                <div class="h-16 rounded-lg overflow-hidden bg-eco-gray">
                    <img src="{{ product.image_4.url }}" alt="{{ product.name }}" class="h-full w-full object-cover">
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Info -->
        <div class="space-y-6">
            <div>
                <p class="text-xs font-semibold text-eco-dark-gray uppercase">{{ product.category.name }}</p>
                <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ product.name }}</h1>
                {% if product.average_rating %}
                <div class="mt-2 flex items-center gap-2 text-sm text-amber-500">
                    <span>
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.average_rating %}⭐{% else %}☆{% endif %}
                        {% endfor %}
                    </span>
                    <span class="text-gray-600">{{ product.average_rating|floatformat:1 }} • {{ reviews|length }} sharh</span>
                </div>
                {% endif %}
                <p class="mt-3 text-gray-700">{{ product.short_description }}</p>
            </div>

            <div class="rounded-2xl border border-gray-100 bg-white shadow-sm p-5">
                <div class="flex items-baseline gap-3">
                    <p class="text-3xl font-bold text-eco-dark-green">{{ product.price|floatformat:0 }} so'm</p>
                    {% if product.has_discount %}
                    <p class="text-sm text-gray-500 line-through">{{ product.original_price|default:product.price|floatformat:0 }} so'm</p>
                    {% endif %}
                </div>
                <div class="mt-2 flex items-center gap-3 text-sm">
                    {% if product.is_in_stock %}
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-eco-light-green text-eco-dark-green font-semibold"><i class="fas fa-check-circle"></i> Mavjud ({{ product.stock_quantity }} dona)</span>
                    {% else %}
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-900 text-white font-semibold"><i class="fas fa-times-circle"></i> Mavjud emas</span>
                    {% endif %}
                </div>
                <div class="mt-4 flex flex-col sm:flex-row gap-3">
                    <label class="text-sm text-gray-700">Miqdor</label>
                    <div class="flex items-center gap-2">
                        <input id="quantityInput" type="number" value="1" min="1" max="{{ product.stock_quantity }}" class="w-20 text-center border border-gray-200 rounded-lg h-10" {% if not product.is_in_stock %}disabled{% endif %}>
                        <button id="addToCartBtn" class="inline-flex items-center justify-center px-5 py-3 rounded-xl bg-eco-green text-white font-semibold hover:bg-eco-dark-green transition" {% if not product.is_in_stock %}disabled{% endif %}>
                            <i class="fas fa-shopping-cart mr-2"></i> Savatga qo'shish
                        </button>
                    </div>
                    <a href="{% url 'shop:cart' %}" class="inline-flex items-center justify-center px-5 py-3 rounded-xl border border-gray-200 text-gray-800 font-semibold hover:bg-gray-50 transition">
                        Savatga o'tish
                    </a>
                    {% if user.is_authenticated %}
                    <button id="wishlistBtn" class="inline-flex items-center justify-center px-4 py-3 rounded-xl border border-rose-200 text-rose-600 font-semibold hover:bg-rose-50 transition">
                        <i id="wishlistIcon" class="{% if in_wishlist %}fas{% else %}far{% endif %} fa-heart mr-2"></i> Sevimlilar
                    </button>
                    {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="inline-flex items-center justify-center px-4 py-3 rounded-xl border border-gray-200 text-gray-800 font-semibold hover:bg-gray-50 transition">
                        Kirish
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
                {% if product.light_requirement %}
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs font-semibold text-eco-dark-gray uppercase">Yorug'lik</p>
                    <p class="text-gray-800">{{ product.light_requirement }}</p>
                </div>
                {% endif %}
                {% if product.water_requirement %}
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs font-semibold text-eco-dark-gray uppercase">Sug'orish</p>
                    <p class="text-gray-800">{{ product.water_requirement }}</p>
                </div>
                {% endif %}
                {% if product.temperature_range %}
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs font-semibold text-eco-dark-gray uppercase">Harorat</p>
                    <p class="text-gray-800">{{ product.temperature_range }}</p>
                </div>
                {% endif %}
                {% if product.care_level %}
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs font-semibold text-eco-dark-gray uppercase">Parvarish darajasi</p>
                    <p class="text-gray-800">{{ product.care_level }}</p>
                </div>
                {% endif %}
            </div>

            <div class="grid grid-cols-3 gap-3 text-center">
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs text-eco-dark-gray font-semibold uppercase">Ko'rishlar</p>
                    <p class="text-xl font-bold text-gray-900">{{ product.views_count }}</p>
                </div>
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs text-eco-dark-gray font-semibold uppercase">Sotuvlar</p>
                    <p class="text-xl font-bold text-gray-900">{{ product.sales_count }}</p>
                </div>
                <div class="rounded-2xl bg-white border border-gray-100 p-4 shadow-sm">
                    <p class="text-xs text-eco-dark-gray font-semibold uppercase">Kategoriya</p>
                    <p class="text-sm font-semibold text-gray-800">{{ product.category.name }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-10 grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
            <div class="border-b border-gray-100 pb-4 mb-4 flex items-center gap-3">
                <i class="fas fa-info-circle text-eco-dark-green"></i>
                <h2 class="text-xl font-semibold text-gray-900">Mahsulot haqida</h2>
            </div>
            <div class="prose max-w-none text-gray-700">
                {{ product.description|linebreaks }}
            </div>
        </div>

        <div class="space-y-4">
            <div class="rounded-2xl bg-white border border-gray-100 p-5 shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-comments text-eco-dark-green"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Sharhlar ({{ reviews|length }})</h3>
                </div>
                <div class="space-y-4">
                    {% for review in reviews %}
                    <div class="rounded-xl border border-gray-100 p-4 bg-eco-gray">
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span class="font-semibold text-gray-800">{{ review.user_name }}</span>
                            <span>{{ review.created_at|date:"d.m.Y" }}</span>
                        </div>
                        <div class="mt-1 text-amber-500 text-sm">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}⭐{% else %}☆{% endif %}
                            {% endfor %}
                        </div>
                        <p class="mt-2 text-gray-700 text-sm">{{ review.comment }}</p>
                        {% if review.image %}
                        <div class="mt-2 h-24 w-32 rounded-lg overflow-hidden border border-gray-200">
                            <img src="{{ review.image.url }}" alt="Sharh rasmi" class="h-full w-full object-cover">
                        </div>
                        {% endif %}
                        <button class="mt-2 text-xs text-eco-dark-green font-semibold inline-flex items-center gap-1 border border-eco-light-green px-3 py-1 rounded-lg">
                            <i class="fas fa-thumbs-up"></i> Foydali ({{ review.helpful_count }})
                        </button>
                    </div>
                    {% empty %}
                    <p class="text-sm text-gray-600">Hozircha sharhlar yo'q. Birinchi bo'lib sharh qoldiring!</p>
                    {% endfor %}
                </div>
                {% if user.is_authenticated %}
                <div class="mt-4">
                    <a href="#" class="inline-flex items-center px-4 py-2 rounded-lg bg-eco-green text-white font-semibold hover:bg-eco-dark-green transition text-sm">Sharh qoldirish</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if related_products %}
    <div class="mt-10 bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">O'xshash Mahsulotlar</h3>
            <a href="{% url 'shop:product_list' %}" class="text-eco-green text-sm font-semibold">Barchasini ko'rish →</a>
        </div>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            {% for related in related_products %}
            <div class="rounded-2xl border border-gray-100 bg-white shadow-sm hover:shadow-md transition overflow-hidden flex flex-col">
                {% with rimg=related.main_image|default_if_none:related.image_2|default_if_none:related.image_3|default_if_none:related.image_4 %}
                {% if rimg %}
                <div class="h-40 bg-eco-gray overflow-hidden">
                    <img src="{{ rimg.url }}" alt="{{ related.name }}" class="h-full w-full object-cover">
                </div>
                {% else %}
                <div class="h-40 bg-eco-gray flex items-center justify-center text-eco-dark-gray">
                    <i class="fas fa-seedling"></i>
                </div>
                {% endif %}
                {% endwith %}
                <div class="p-4 flex-1 flex flex-col gap-2">
                    <h4 class="text-sm font-semibold text-gray-900">{{ related.name }}</h4>
                    <p class="text-eco-dark-green font-bold">{{ related.price|floatformat:0 }} so'm</p>
                    <a href="{% url 'shop:product_detail' related.slug %}" class="mt-auto inline-flex items-center justify-center px-3 py-2 rounded-lg bg-eco-green text-white text-sm font-semibold hover:bg-eco-dark-green transition">Ko'rish</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
<script>
const addToCartBtn = document.getElementById('addToCartBtn');
const wishlistBtn = document.getElementById('wishlistBtn');
const wishlistIcon = document.getElementById('wishlistIcon');
const quantityInput = document.getElementById('quantityInput');
const cartApiAdd = "{% url 'shop:home' %}api/cart/add_item/";
const wishlistAdd = "{% url 'shop:home' %}api/wishlist/add_product/";
const wishlistRemove = "{% url 'shop:home' %}api/wishlist/remove_product/";
const productId = {{ product.id }};

function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
}

if (addToCartBtn) {
    addToCartBtn.addEventListener('click', () => {
        const quantity = parseInt(quantityInput?.value || '1', 10);
        addToCartBtn.disabled = true;
        addToCartBtn.innerText = 'Qo\'shilmoqda...';
        fetch(cartApiAdd, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ product_id: productId, quantity: quantity })
        }).then(resp => {
            if (!resp.ok) throw new Error('Savatga qo\'shib bo\'lmadi');
            return resp.json();
        }).then(() => {
            addToCartBtn.innerText = "Savatga qo'shildi";
            addToCartBtn.classList.add('bg-eco-dark-green');
        }).catch(() => {
            alert('Savatga qo\'shishda xatolik yuz berdi');
            addToCartBtn.innerText = "Savatga qo'shish";
        }).finally(() => {
            addToCartBtn.disabled = false;
        });
    });
}

if (wishlistBtn && wishlistIcon) {
    wishlistBtn.addEventListener('click', () => {
        const isActive = wishlistIcon.classList.contains('fas');
        const targetUrl = isActive ? wishlistRemove : wishlistAdd;
        fetch(targetUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ product_id: productId })
        }).then(resp => {
            if (!resp.ok) throw new Error('Sevimlilarni yangilab bo\'lmadi');
            return resp.json();
        }).then(() => {
            wishlistIcon.classList.toggle('fas');
            wishlistIcon.classList.toggle('far');
        }).catch(() => {
            alert('Sevimlilarni yangilashda xatolik yuz berdi');
        });
    });
}
</script>
{% endblock %}
